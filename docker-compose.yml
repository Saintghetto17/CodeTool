services:
  code-agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: code-agent:latest
    container_name: code-agent
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      # Important: empty OPENAI_BASE_URL breaks OpenAI SDK (missing http/https).
      # Default to official endpoint.
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - YANDEX_API_KEY=${YANDEX_API_KEY:-}
      - YANDEX_FOLDER_ID=${YANDEX_FOLDER_ID:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./:/workspace:rw
      - ~/.gitconfig:/home/codeagent/.gitconfig:ro
      - ~/.ssh:/home/codeagent/.ssh:ro
    working_dir: /workspace
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]

  # CLI runner: use image ENTRYPOINT (python -m code_agent.cli)
  # Usage:
  #   docker compose run --rm code-agent-cli review-pr 123
  #   docker compose run --rm code-agent-cli process-issue 456
  code-agent-cli:
    build:
      context: .
      dockerfile: Dockerfile
    image: code-agent:latest
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      # Important: empty OPENAI_BASE_URL breaks OpenAI SDK (missing http/https).
      # Default to official endpoint.
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - YANDEX_API_KEY=${YANDEX_API_KEY:-}
      - YANDEX_FOLDER_ID=${YANDEX_FOLDER_ID:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - MAX_ITERATIONS=${MAX_ITERATIONS:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./:/workspace:rw
      - ~/.gitconfig:/home/codeagent/.gitconfig:ro
      - ~/.ssh:/home/codeagent/.ssh:ro
    working_dir: /workspace
    
  # Optional: Service for running in daemon mode with webhook server
  code-agent-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: code-agent:latest
    container_name: code-agent-server
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPO=${GITHUB_REPO}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - YANDEX_API_KEY=${YANDEX_API_KEY:-}
      - YANDEX_FOLDER_ID=${YANDEX_FOLDER_ID:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8080:8080"
    volumes:
      - ./:/workspace:rw
    working_dir: /workspace
    profiles:
      - server
    # Note: Would need webhook server implementation
    command: ["--help"]

